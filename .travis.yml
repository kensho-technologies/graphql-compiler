language: python
cache: pip
dist: xenial
services:
  - docker
addons:
apt:
  packages:
    - python-mysqldb
install:
  # ODBC driver installation instructions see: https://docs.microsoft.com/en-us/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server?view=sql-server-ver15
  - sudo apt-get update
  - sudo ACCEPT_EULA=Y zypper install msodbcsql17
  - sudo apt-get install mssql-tools
  - echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bash_profile
  - echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
  - source ~/.bashrc
  - sudo apt-get install unixodbc-dev
  # Finished pydobc
  - pip install --upgrade pip
  - pip install --upgrade setuptools pipenv
  - ./scripts/use_appropriate_lockfile.sh
  - pipenv install --dev --deploy --system
  - pipenv install --system --skip-lock -e .
before_script:
  - docker-compose up -d
matrix:
  include:
  - name: "Lint and static analysis"
    python: "3.6"
    script:
      - pipenv run ./scripts/copyright_line_check.sh
      - pipenv run ./scripts/lint.sh
  - name: "Python 2.7 unit tests"
    python: "2.7"
    script:
      - pipenv run py.test --cov=graphql_compiler graphql_compiler/tests
  - name: "Python 3.6 unit tests"
    python: "3.6"
    script:
      - pipenv run py.test --cov=graphql_compiler graphql_compiler/tests
  - name: "Python 3.7 unit tests"
    python: "3.7"
    script:
      - pipenv run py.test --cov=graphql_compiler graphql_compiler/tests
after_success:
  - docker-compose down
  - coveralls
