language: python
cache: pip
dist: xenial
services:
  - docker
addons:
apt:
  packages:
    - python-mysqldb
install:
  # Microsoft ODBC driver installation.
  - sudo bash -c "curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -"
  - sudo bash -c "curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -r -s)/prod.list > /etc/apt/sources.list.d/mssql-release.list"
  - sudo apt-get update
  - sudo ACCEPT_EULA=Y apt-get install msodbcsql17
  - sudo apt-get install unixodbc-dev

  - pip install --upgrade pip
  - pip install --upgrade setuptools pipenv
  - ./scripts/use_appropriate_lockfile.sh
  - pipenv install --dev --deploy --system
  - pipenv install --system --skip-lock -e .
before_script:
  - docker-compose up -d
matrix:
  include:
  - name: "Lint and static analysis"
    python: "3.6"
    script:
      - pipenv run ./scripts/copyright_line_check.sh
      - pipenv run ./scripts/lint.sh
  - name: "Python 2.7 unit tests"
    python: "2.7"
    script:
      - pipenv run py.test --cov=graphql_compiler graphql_compiler/tests
  - name: "Python 3.6 unit tests"
    python: "3.6"
    script:
      - pipenv run py.test --cov=graphql_compiler graphql_compiler/tests
  - name: "Python 3.7 unit tests"
    python: "3.7"
    script:
      - pipenv run py.test --cov=graphql_compiler graphql_compiler/tests
after_success:
  - docker-compose down
  - coveralls
